<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–û—Ç–∫–ª–∏–∫–∏ ‚Äî –¢–ï–ô–ü –†–û–ü</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

:root {
  --bg: #0a0a0a;
  --bg-card: #151515;
  --bg-card-hover: #1a1a1a;
  --text: #f0f0f0;
  --text-muted: #888;
  --accent: #ff6b2b;
  --accent-light: #ff8f5e;
  --accent-glow: rgba(255, 107, 43, 0.15);
  --gradient: linear-gradient(135deg, #ff6b2b, #ffb347);
  --border: #222;
  --radius: 16px;
  --radius-sm: 10px;
  --green: #22c55e;
  --yellow: #eab308;
  --blue: #3b82f6;
  --red: #ef4444;
}

html { scroll-behavior: smooth; }

body {
  font-family: 'Manrope', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  min-height: 100vh;
}

/* ======================== AUTH SCREEN ======================== */
.auth-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
}

.auth-box {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 48px 40px;
  max-width: 400px;
  width: 100%;
  text-align: center;
}

.auth-box .logo {
  width: 48px;
  height: auto;
  margin-bottom: 24px;
  opacity: 0.9;
}

.auth-box h1 {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 8px;
}

.auth-box p {
  color: var(--text-muted);
  font-size: 0.9rem;
  margin-bottom: 24px;
}

.auth-input {
  width: 100%;
  padding: 14px 18px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: inherit;
  font-size: 1rem;
  outline: none;
  transition: border-color 0.3s;
  margin-bottom: 16px;
}

.auth-input:focus {
  border-color: var(--accent);
}

.auth-input.shake {
  animation: shake 0.4s ease;
  border-color: var(--red);
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-8px); }
  75% { transform: translateX(8px); }
}

.auth-btn {
  width: 100%;
  padding: 14px;
  background: var(--gradient);
  border: none;
  border-radius: var(--radius-sm);
  color: #fff;
  font-family: inherit;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: opacity 0.2s;
}

.auth-btn:hover { opacity: 0.9; }

.auth-error {
  color: var(--red);
  font-size: 0.85rem;
  margin-top: 12px;
  display: none;
}

/* ======================== DASHBOARD ======================== */
.dashboard {
  display: none;
  max-width: 1200px;
  margin: 0 auto;
  padding: 32px 24px;
}

.dashboard.active {
  display: block;
}

/* Header */
.dash-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 32px;
  flex-wrap: wrap;
  gap: 16px;
}

.dash-header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.dash-header-left .logo {
  width: 36px;
  height: auto;
  opacity: 0.9;
}

.dash-header h1 {
  font-size: 1.5rem;
  font-weight: 700;
}

.dash-header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.btn-sheets {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 18px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: inherit;
  font-size: 0.85rem;
  font-weight: 600;
  text-decoration: none;
  transition: border-color 0.3s;
}

.btn-sheets:hover { border-color: var(--accent); }

.btn-logout {
  padding: 10px 18px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-muted);
  font-family: inherit;
  font-size: 0.85rem;
  cursor: pointer;
  transition: border-color 0.3s, color 0.3s;
}

.btn-logout:hover { border-color: var(--red); color: var(--red); }

/* Stats */
.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 20px;
}

.stat-card .stat-value {
  font-size: 2rem;
  font-weight: 800;
}

.stat-card .stat-label {
  color: var(--text-muted);
  font-size: 0.85rem;
  margin-top: 4px;
}

.stat-card.accent .stat-value { color: var(--accent); }
.stat-card.green .stat-value { color: var(--green); }
.stat-card.blue .stat-value { color: var(--blue); }
.stat-card.yellow .stat-value { color: var(--yellow); }

/* Filters */
.filters-row {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.search-input {
  flex: 1;
  min-width: 200px;
  padding: 12px 18px;
  padding-left: 42px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-family: inherit;
  font-size: 0.9rem;
  outline: none;
  transition: border-color 0.3s;
}

.search-input:focus { border-color: var(--accent); }

.search-wrap {
  position: relative;
  flex: 1;
  min-width: 200px;
}

.search-wrap svg {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  width: 18px;
  height: 18px;
}

.filter-btn {
  padding: 10px 18px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-muted);
  font-family: inherit;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.filter-btn:hover { border-color: var(--text-muted); color: var(--text); }
.filter-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }

/* Table */
.table-wrap {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}

.table-wrap table {
  width: 100%;
  border-collapse: collapse;
}

.table-wrap th {
  text-align: left;
  padding: 14px 18px;
  font-size: 0.8rem;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

.table-wrap td {
  padding: 14px 18px;
  font-size: 0.9rem;
  border-bottom: 1px solid #1a1a1a;
  vertical-align: top;
}

.table-wrap tr:last-child td { border-bottom: none; }

.table-wrap tbody tr {
  cursor: pointer;
  transition: background 0.2s;
}

.table-wrap tbody tr:hover { background: var(--bg-card-hover); }

.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  white-space: nowrap;
}

.status-badge.new { background: rgba(255, 107, 43, 0.15); color: var(--accent); }
.status-badge.review { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }
.status-badge.interview { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
.status-badge.rejected { background: rgba(239, 68, 68, 0.1); color: var(--red); }
.status-badge.hired { background: rgba(34, 197, 94, 0.15); color: var(--green); }

.tg-link {
  color: var(--accent-light);
  text-decoration: none;
}
.tg-link:hover { text-decoration: underline; }

.date-cell {
  color: var(--text-muted);
  font-size: 0.85rem;
  white-space: nowrap;
}

/* Detail modal */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 24px;
  backdrop-filter: blur(4px);
}

.modal-overlay.active { display: flex; }

.modal {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  max-width: 700px;
  width: 100%;
  max-height: 85vh;
  overflow-y: auto;
  padding: 32px;
}

.modal-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 24px;
}

.modal-header h2 {
  font-size: 1.3rem;
  font-weight: 700;
}

.modal-close {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 4px 8px;
  line-height: 1;
  transition: color 0.2s;
}

.modal-close:hover { color: var(--text); }

.modal-contacts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.modal-contact {
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
}

.modal-contact .label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 4px;
}

.modal-contact .value {
  font-weight: 600;
  word-break: break-all;
}

.modal-contact .value a {
  color: var(--accent-light);
  text-decoration: none;
}

.modal-contact .value a:hover { text-decoration: underline; }

.modal-question {
  margin-bottom: 20px;
}

.modal-question .q-label {
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 8px;
}

.modal-question .q-answer {
  background: var(--bg);
  border-radius: var(--radius-sm);
  padding: 16px;
  font-size: 0.9rem;
  line-height: 1.7;
  white-space: pre-wrap;
}

.modal-meta {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
  margin-top: 8px;
}

.modal-meta .meta-date {
  color: var(--text-muted);
  font-size: 0.85rem;
}

/* Status selector */
.status-selector {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.status-selector .status-option {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
  opacity: 0.4;
  user-select: none;
}

.status-selector .status-option:hover {
  opacity: 0.7;
}

.status-selector .status-option.active {
  opacity: 1;
  border-color: currentColor;
}

.status-option.new { background: rgba(255, 107, 43, 0.15); color: var(--accent); }
.status-option.review { background: rgba(234, 179, 8, 0.15); color: var(--yellow); }
.status-option.interview { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
.status-option.rejected { background: rgba(239, 68, 68, 0.1); color: var(--red); }
.status-option.hired { background: rgba(34, 197, 94, 0.15); color: var(--green); }

.status-change-label {
  font-size: 0.75rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 8px;
}

.modal-meta-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* Loading */
.loading {
  text-align: center;
  padding: 60px 24px;
  color: var(--text-muted);
}

.loading-spinner {
  display: inline-block;
  width: 32px;
  height: 32px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 16px;
}

@keyframes spin { to { transform: rotate(360deg); } }

.empty-state {
  text-align: center;
  padding: 60px 24px;
  color: var(--text-muted);
}

.empty-state .empty-icon {
  font-size: 3rem;
  margin-bottom: 16px;
}

.btn-refresh {
  padding: 10px 20px;
  background: var(--gradient);
  border: none;
  border-radius: var(--radius-sm);
  color: #fff;
  font-family: inherit;
  font-size: 0.85rem;
  font-weight: 700;
  cursor: pointer;
  transition: opacity 0.2s;
}

.btn-refresh:hover { opacity: 0.9; }

/* Mobile cards */
.mobile-cards {
  display: none;
}

.mobile-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 18px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: border-color 0.2s;
}

.mobile-card:hover { border-color: var(--accent); }

.mobile-card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.mobile-card-name {
  font-weight: 700;
  font-size: 1rem;
}

.mobile-card-meta {
  display: flex;
  gap: 16px;
  color: var(--text-muted);
  font-size: 0.85rem;
}

.mobile-card-date {
  color: var(--text-muted);
  font-size: 0.8rem;
  margin-top: 8px;
}

/* Config notice */
.config-notice {
  background: rgba(255, 107, 43, 0.1);
  border: 1px solid rgba(255, 107, 43, 0.3);
  border-radius: var(--radius-sm);
  padding: 20px;
  margin-bottom: 24px;
  font-size: 0.9rem;
  line-height: 1.7;
}

.config-notice strong {
  color: var(--accent);
}

.config-notice code {
  background: var(--bg);
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.85rem;
}

@media (max-width: 768px) {
  .table-wrap { display: none; }
  .mobile-cards { display: block; }
  .dash-header { flex-direction: column; align-items: flex-start; }
  .stats-row { grid-template-columns: repeat(2, 1fr); }
  .modal { padding: 24px; }
  .modal-contacts { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<!-- ======================== AUTH ======================== -->
<div class="auth-screen" id="authScreen">
  <div class="auth-box">
    <img src="logo.png" alt="TAPE" class="logo">
    <h1>–û—Ç–∫–ª–∏–∫–∏ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é</h1>
    <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞</p>
    <input type="password" class="auth-input" id="authPassword" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off">
    <button class="auth-btn" id="authBtn">–í–æ–π—Ç–∏</button>
    <div class="auth-error" id="authError">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
  </div>
</div>

<!-- ======================== DASHBOARD ======================== -->
<div class="dashboard" id="dashboard">

  <!-- Header -->
  <div class="dash-header">
    <div class="dash-header-left">
      <img src="logo.png" alt="TAPE" class="logo">
      <h1>–û—Ç–∫–ª–∏–∫–∏ ‚Äî –†–û–ü</h1>
    </div>
    <div class="dash-header-right">
      <a href="#" class="btn-sheets" id="sheetsLink" target="_blank">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
        Google Sheets
      </a>
      <button class="btn-refresh" id="refreshBtn">
        –û–±–Ω–æ–≤–∏—Ç—å
      </button>
      <button class="btn-logout" id="logoutBtn">–í—ã–π—Ç–∏</button>
    </div>
  </div>

  <!-- Config notice (shown when SHEET_ID not set) -->
  <div class="config-notice" id="configNotice" style="display:none;">
    <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.</strong> –ó–∞–º–µ–Ω–∏—Ç–µ <code>SHEET_ID</code> –∏ <code>APPS_SCRIPT_URL</code> –≤ –∫–æ–¥–µ admin.html –∏ index.html –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ Google Sheets / Apps Script.
  </div>

  <!-- Stats -->
  <div class="stats-row" id="statsRow">
    <div class="stat-card accent">
      <div class="stat-value" id="statTotal">‚Äî</div>
      <div class="stat-label">–í—Å–µ–≥–æ –æ—Ç–∫–ª–∏–∫–æ–≤</div>
    </div>
    <div class="stat-card green">
      <div class="stat-value" id="statNew">‚Äî</div>
      <div class="stat-label">–ù–æ–≤—ã–µ</div>
    </div>
    <div class="stat-card yellow">
      <div class="stat-value" id="statReview">‚Äî</div>
      <div class="stat-label">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</div>
    </div>
    <div class="stat-card blue">
      <div class="stat-value" id="statInterview">‚Äî</div>
      <div class="stat-label">–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-row">
    <div class="search-wrap">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É, telegram...">
    </div>
    <button class="filter-btn active" data-status="all">–í—Å–µ</button>
    <button class="filter-btn" data-status="–ù–æ–≤—ã–π">–ù–æ–≤—ã–µ</button>
    <button class="filter-btn" data-status="–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</button>
    <button class="filter-btn" data-status="–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ">–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ</button>
    <button class="filter-btn" data-status="–û—Ç–∫–∞–∑">–û—Ç–∫–∞–∑</button>
  </div>

  <!-- Loading -->
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <div>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∫–ª–∏–∫–æ–≤...</div>
  </div>

  <!-- Empty state -->
  <div class="empty-state" id="emptyState" style="display:none;">
    <div class="empty-icon">üì≠</div>
    <div>–û—Ç–∫–ª–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
  </div>

  <!-- Table (desktop) -->
  <div class="table-wrap" id="tableWrap" style="display:none;">
    <table>
      <thead>
        <tr>
          <th>–î–∞—Ç–∞</th>
          <th>–ò–º—è</th>
          <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
          <th>Telegram</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Mobile cards -->
  <div class="mobile-cards" id="mobileCards"></div>

</div>

<!-- ======================== DETAIL MODAL ======================== -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modal">
    <div class="modal-header">
      <h2 id="modalName"></h2>
      <button class="modal-close" id="modalClose">&times;</button>
    </div>
    <div class="modal-contacts" id="modalContacts"></div>
    <div id="modalQuestions"></div>
    <div class="modal-meta">
      <div class="modal-meta-row">
        <div class="meta-date" id="modalDate"></div>
      </div>
      <div>
        <div class="status-change-label">–°—Ç–∞—Ç—É—Å</div>
        <div class="status-selector" id="statusSelector">
          <span class="status-option new" data-status="–ù–æ–≤—ã–π">–ù–æ–≤—ã–π</span>
          <span class="status-option review" data-status="–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>
          <span class="status-option interview" data-status="–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ">–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ</span>
          <span class="status-option rejected" data-status="–û—Ç–∫–∞–∑">–û—Ç–∫–∞–∑</span>
          <span class="status-option hired" data-status="–ü—Ä–∏–Ω—è—Ç">–ü—Ä–∏–Ω—è—Ç</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ======================== CONFIG ======================== */
const SHEET_ID = '1Yo-hnKTuQCl2sOuPYD8a9C3cNB2FBv0J2DAGGaJCOKk';
const SHEET_GID = '1835890803'; // Google Form responses sheet
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}`;
const DATA_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;
const PASSWORD = 'tape2024';
// Column name mapping (Google Form headers ‚Üí dashboard keys)
const COL_MAP = {
  '–û—Ç–º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏': '–î–∞—Ç–∞',
  '–°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–∑—é–º–µ': '–†–µ–∑—é–º–µ'
};

/* ======================== STATUS PERSISTENCE (localStorage) ======================== */
const STATUS_STORAGE_KEY = 'tape_rop_statuses';

function getAppKey(app) {
  // Unique key from date + name + phone
  return btoa(encodeURIComponent((app['–î–∞—Ç–∞'] || '') + '|' + (app['–ò–º—è'] || '') + '|' + (app['–¢–µ–ª–µ—Ñ–æ–Ω'] || '')));
}

function getAllStatusOverrides() {
  try {
    return JSON.parse(localStorage.getItem(STATUS_STORAGE_KEY) || '{}');
  } catch { return {}; }
}

function getAppStatus(app) {
  const overrides = getAllStatusOverrides();
  const key = getAppKey(app);
  return overrides[key] || app['–°—Ç–∞—Ç—É—Å'] || '–ù–æ–≤—ã–π';
}

function setAppStatus(app, newStatus) {
  const overrides = getAllStatusOverrides();
  const key = getAppKey(app);
  overrides[key] = newStatus;
  localStorage.setItem(STATUS_STORAGE_KEY, JSON.stringify(overrides));
  // Also update in-memory
  app['–°—Ç–∞—Ç—É—Å'] = newStatus;
}

let currentModalIndex = -1;

/* ======================== AUTH ======================== */
const authScreen = document.getElementById('authScreen');
const dashboard = document.getElementById('dashboard');
const authPassword = document.getElementById('authPassword');
const authBtn = document.getElementById('authBtn');
const authError = document.getElementById('authError');

function checkAuth() {
  if (sessionStorage.getItem('tape_admin_auth') === 'true') {
    authScreen.style.display = 'none';
    dashboard.classList.add('active');
    loadData();
  }
}

function login() {
  if (authPassword.value === PASSWORD) {
    sessionStorage.setItem('tape_admin_auth', 'true');
    authScreen.style.display = 'none';
    dashboard.classList.add('active');
    authError.style.display = 'none';
    loadData();
  } else {
    authError.style.display = 'block';
    authPassword.classList.add('shake');
    setTimeout(() => authPassword.classList.remove('shake'), 400);
  }
}

authBtn.addEventListener('click', login);
authPassword.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') login();
});

document.getElementById('logoutBtn').addEventListener('click', () => {
  sessionStorage.removeItem('tape_admin_auth');
  location.reload();
});

/* ======================== DATA ======================== */
let allApplications = [];
let currentFilter = 'all';

function parseGoogleSheetsJSON(text) {
  // Google Sheets returns JSONP-like format: google.visualization.Query.setResponse({...})
  const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+)\);?/);
  if (!match) return [];

  const json = JSON.parse(match[1]);
  const cols = json.table.cols.map(c => c.label);
  const rows = json.table.rows || [];

  return rows.map(row => {
    const obj = {};
    row.c.forEach((cell, i) => {
      if (cols[i]) {
        // Apply column name mapping
        const key = COL_MAP[cols[i]] || cols[i];
        if (cell && cell.v !== null && cell.v !== undefined) {
          // Handle date type
          if (cell.f) {
            obj[key] = cell.f; // Use formatted value
          } else {
            obj[key] = cell.v;
          }
        } else {
          obj[key] = '';
        }
      }
    });
    // Add default status if not present
    if (!obj['–°—Ç–∞—Ç—É—Å']) obj['–°—Ç–∞—Ç—É—Å'] = '–ù–æ–≤—ã–π';
    // Apply localStorage status override
    const overrides = getAllStatusOverrides();
    const key = getAppKey(obj);
    if (overrides[key]) obj['–°—Ç–∞—Ç—É—Å'] = overrides[key];
    return obj;
  });
}

async function loadData() {
  const loading = document.getElementById('loading');
  const emptyState = document.getElementById('emptyState');
  const tableWrap = document.getElementById('tableWrap');
  const configNotice = document.getElementById('configNotice');

  loading.style.display = 'block';
  emptyState.style.display = 'none';
  tableWrap.style.display = 'none';

  configNotice.style.display = 'none';

  try {
    const resp = await fetch(DATA_URL);
    const text = await resp.text();
    allApplications = parseGoogleSheetsJSON(text);
    // Reverse so newest first
    allApplications.reverse();
  } catch (err) {
    console.error('Failed to load data:', err);
    allApplications = [];
  }

  loading.style.display = 'none';
  renderAll();
}

function getDemoData() {
  return [
    {
      '–î–∞—Ç–∞': '24.02.2026 14:30',
      '–ò–º—è': '–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',
      '–¢–µ–ª–µ—Ñ–æ–Ω': '+7 (999) 123-45-67',
      'Telegram': '@ivan_petrov',
      '–†–µ–∑—é–º–µ': 'https://hh.ru/resume/123',
      '–õ—É—á—à–∞—è —Å–¥–µ–ª–∫–∞': '–ó–∞–∫—Ä—ã–ª –∫–æ–Ω—Ç—Ä–∞–∫—Ç —Å –Ø–Ω–¥–µ–∫—Å–æ–º –Ω–∞ 15 –º–ª–Ω –∑–∞ —Å–µ—Ä–∏—é —Ä–æ–ª–∏–∫–æ–≤ –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–ú–∞—Ä–∫–µ—Ç–∞. –í—ã—à–µ–ª –Ω–∞ –Ω–∏—Ö —á–µ—Ä–µ–∑ –∑–Ω–∞–∫–æ–º–æ–≥–æ –ø—Ä–æ–¥—é—Å–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–ª —Å –∏—Ö –∞–≥–µ–Ω—Ç—Å—Ç–≤–æ–º. –ü—Ä–æ–≤—ë–ª 4 –≤—Å—Ç—Ä–µ—á–∏ –∑–∞ 2 –Ω–µ–¥–µ–ª–∏, —Å–¥–µ–ª–∞–ª –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π pitch deck.',
      '–ü–ª–∞–Ω –ø–æ —Ç–µ–Ω–¥–µ—Ä–∞–º': '–°–æ—Å—Ç–∞–≤–∏–ª –±—ã —Å–ø–∏—Å–æ–∫ —Ç–æ–ø-50 –∞–≥–µ–Ω—Ç—Å—Ç–≤, –Ω–∞—à—ë–ª –∫–æ–Ω—Ç–∞–∫—Ç—ã –õ–ü–† —á–µ—Ä–µ–∑ LinkedIn –∏ Telegram-—á–∞—Ç—ã –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–≤. –ü–µ—Ä–≤—ã–µ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî cold outreach —Å –∫–µ–π—Å–∞–º–∏. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä—é —Ç–µ–Ω–¥–µ—Ä–Ω—ã–µ –ø–ª–æ—â–∞–¥–∫–∏. –ù–∞ 3-4 –Ω–µ–¥–µ–ª–µ ‚Äî –ª–∏—á–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏ —Å —Ç–µ–º–∏, –∫—Ç–æ –æ—Ç–≤–µ—Ç–∏–ª.',
      '–ú–æ—Ç–∏–≤–∞—Ü–∏—è': '–î–∞–≤–Ω–æ —Å–ª–µ–∂—É –∑–∞ –¢–ï–ô–ü, –Ω—Ä–∞–≤–∏—Ç—Å—è –ø–æ–¥—Ö–æ–¥ –∫ –∫–æ–Ω—Ç–µ–Ω—Ç—É.',
      '–°—Ç–∞—Ç—É—Å': '–ù–æ–≤—ã–π'
    },
    {
      '–î–∞—Ç–∞': '23.02.2026 11:15',
      '–ò–º—è': '–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞',
      '–¢–µ–ª–µ—Ñ–æ–Ω': '+7 (916) 555-88-99',
      'Telegram': '@m_sidorova',
      '–†–µ–∑—é–º–µ': '',
      '–õ—É—á—à–∞—è —Å–¥–µ–ª–∫–∞': '–ü—Ä–∏–≤–µ–ª–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Ñ–∞—Ä–º-–∏–Ω–¥—É—Å—Ç—Ä–∏–∏ ‚Äî –≥–æ–¥–æ–≤–æ–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ 8 –º–ª–Ω. –ù–∞—à–ª–∞ —á–µ—Ä–µ–∑ –æ—Ç—Ä–∞—Å–ª–µ–≤—É—é –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—é, –≥–¥–µ –≤—ã—Å—Ç—É–ø–∞–ª–∞ —Å –¥–æ–∫–ª–∞–¥–æ–º. –ß–µ–∫ –ø–µ—Ä–≤–æ–π —Å–¥–µ–ª–∫–∏ –±—ã–ª 2 –º–ª–Ω, –ø–æ—Ç–æ–º —Ä–∞—Å—à–∏—Ä–∏–ª–∏ –¥–æ –≥–æ–¥–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞.',
      '–ü–ª–∞–Ω –ø–æ —Ç–µ–Ω–¥–µ—Ä–∞–º': '–ù–∞—á–∞–ª–∞ –±—ã —Å –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—É—â–∏—Ö —Ç–µ–Ω–¥–µ—Ä–æ–≤ –Ω–∞ –ø–ª–æ—â–∞–¥–∫–∞—Ö —Ç–∏–ø–∞ B2B-Center. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ ‚Äî networking –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö. –ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∞ –±—ã —à–æ—É—Ä–∏–ª –ø–æ–¥ –∫–∞–∂–¥—ã–π —Å–µ–≥–º–µ–Ω—Ç. –ó–∞ 30 –¥–Ω–µ–π —Ä–µ–∞–ª—å–Ω–æ –≤–æ–π—Ç–∏ –≤ 3-5 –ø—É–ª–æ–≤.',
      '–ú–æ—Ç–∏–≤–∞—Ü–∏—è': '',
      '–°—Ç–∞—Ç—É—Å': '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏'
    },
    {
      '–î–∞—Ç–∞': '22.02.2026 09:00',
      '–ò–º—è': '–ê–ª–µ–∫—Å–µ–π –ö–æ–∑–ª–æ–≤',
      '–¢–µ–ª–µ—Ñ–æ–Ω': '+7 (905) 777-33-11',
      'Telegram': '@kozlov_sales',
      '–†–µ–∑—é–º–µ': 'https://drive.google.com/file/resume',
      '–õ—É—á—à–∞—è —Å–¥–µ–ª–∫–∞': '–ó–∞–∫–ª—é—á–∏–ª –¥–æ–≥–æ–≤–æ—Ä —Å –∫—Ä—É–ø–Ω—ã–º —Ä–∏—Ç–µ–π–ª–µ—Ä–æ–º –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö —Ä–æ–ª–∏–∫–æ–≤ –¥–ª—è 12 –º–∞–≥–∞–∑–∏–Ω–æ–≤. –û–±—â–∏–π —á–µ–∫ ‚Äî 22 –º–ª–Ω. –í—ã—à–µ–ª —á–µ—Ä–µ–∑ CEO –∏—Ö digital-–∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –Ω–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏.',
      '–ü–ª–∞–Ω –ø–æ —Ç–µ–Ω–¥–µ—Ä–∞–º': '–®–∞–≥ 1: –ê—É–¥–∏—Ç —Ç–µ–∫—É—â–µ–π –±–∞–∑—ã –¢–ï–ô–ü –∏ –ø–æ–∏—Å–∫ warm leads. –®–∞–≥ 2: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã. –®–∞–≥ 3: –°–∏—Å—Ç–µ–º–Ω—ã–π outreach ‚Äî 10 –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –≤ –¥–µ–Ω—å. –®–∞–≥ 4: Follow-up –∏ –ª–∏—á–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏.',
      '–ú–æ—Ç–∏–≤–∞—Ü–∏—è': '–•–æ—á—É —Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–¥–∞–∂–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Ä–∞–∑–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏.',
      '–°—Ç–∞—Ç—É—Å': '–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ'
    }
  ];
}

/* ======================== RENDER ======================== */
function renderAll() {
  const filtered = getFilteredData();
  renderStats();
  renderTable(filtered);
  renderMobileCards(filtered);

  const tableWrap = document.getElementById('tableWrap');
  const emptyState = document.getElementById('emptyState');
  const mobileCards = document.getElementById('mobileCards');

  if (filtered.length === 0) {
    tableWrap.style.display = 'none';
    mobileCards.innerHTML = '';
    emptyState.style.display = 'block';
  } else {
    tableWrap.style.display = '';
    emptyState.style.display = 'none';
  }
}

function getFilteredData() {
  const search = document.getElementById('searchInput').value.toLowerCase().trim();
  return allApplications.filter(app => {
    // Status filter
    if (currentFilter !== 'all' && (app['–°—Ç–∞—Ç—É—Å'] || '–ù–æ–≤—ã–π') !== currentFilter) return false;
    // Search
    if (search) {
      const haystack = [app['–ò–º—è'], app['–¢–µ–ª–µ—Ñ–æ–Ω'], app['Telegram']].join(' ').toLowerCase();
      if (!haystack.includes(search)) return false;
    }
    return true;
  });
}

function renderStats() {
  const total = allApplications.length;
  const newCount = allApplications.filter(a => (a['–°—Ç–∞—Ç—É—Å'] || '–ù–æ–≤—ã–π') === '–ù–æ–≤—ã–π').length;
  const reviewCount = allApplications.filter(a => a['–°—Ç–∞—Ç—É—Å'] === '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏').length;
  const interviewCount = allApplications.filter(a => a['–°—Ç–∞—Ç—É—Å'] === '–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ').length;

  document.getElementById('statTotal').textContent = total;
  document.getElementById('statNew').textContent = newCount;
  document.getElementById('statReview').textContent = reviewCount;
  document.getElementById('statInterview').textContent = interviewCount;
}

function getStatusClass(status) {
  const map = {
    '–ù–æ–≤—ã–π': 'new',
    '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏': 'review',
    '–°–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ': 'interview',
    '–û—Ç–∫–∞–∑': 'rejected',
    '–ü—Ä–∏–Ω—è—Ç': 'hired'
  };
  return map[status] || 'new';
}

function renderTable(data) {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = data.map((app, i) => {
    const status = app['–°—Ç–∞—Ç—É—Å'] || '–ù–æ–≤—ã–π';
    const tg = app['Telegram'] || '';
    const tgClean = tg.replace('@', '');
    return `<tr data-index="${i}" onclick="openModal(${allApplications.indexOf(app)})">
      <td class="date-cell">${app['–î–∞—Ç–∞'] || '‚Äî'}</td>
      <td><strong>${app['–ò–º—è'] || '‚Äî'}</strong></td>
      <td>${app['–¢–µ–ª–µ—Ñ–æ–Ω'] || '‚Äî'}</td>
      <td>${tg ? `<a href="https://t.me/${tgClean}" class="tg-link" onclick="event.stopPropagation()" target="_blank">${tg}</a>` : '‚Äî'}</td>
      <td><span class="status-badge ${getStatusClass(status)}">${status}</span></td>
    </tr>`;
  }).join('');
}

function renderMobileCards(data) {
  const container = document.getElementById('mobileCards');
  container.innerHTML = data.map((app, i) => {
    const status = app['–°—Ç–∞—Ç—É—Å'] || '–ù–æ–≤—ã–π';
    const tg = app['Telegram'] || '';
    return `<div class="mobile-card" onclick="openModal(${allApplications.indexOf(app)})">
      <div class="mobile-card-header">
        <div class="mobile-card-name">${app['–ò–º—è'] || '‚Äî'}</div>
        <span class="status-badge ${getStatusClass(status)}">${status}</span>
      </div>
      <div class="mobile-card-meta">
        <span>${app['–¢–µ–ª–µ—Ñ–æ–Ω'] || ''}</span>
        <span>${tg}</span>
      </div>
      <div class="mobile-card-date">${app['–î–∞—Ç–∞'] || ''}</div>
    </div>`;
  }).join('');
}

/* ======================== MODAL ======================== */
function openModal(index) {
  const app = allApplications[index];
  if (!app) return;

  document.getElementById('modalName').textContent = app['–ò–º—è'] || '–ë–µ–∑ –∏–º–µ–Ω–∏';

  // Contacts
  const contacts = document.getElementById('modalContacts');
  const tg = app['Telegram'] || '';
  const tgClean = tg.replace('@', '');
  let contactsHTML = `
    <div class="modal-contact">
      <div class="label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
      <div class="value"><a href="tel:${(app['–¢–µ–ª–µ—Ñ–æ–Ω'] || '').replace(/[^\d+]/g, '')}">${app['–¢–µ–ª–µ—Ñ–æ–Ω'] || '‚Äî'}</a></div>
    </div>
    <div class="modal-contact">
      <div class="label">Telegram</div>
      <div class="value">${tg ? `<a href="https://t.me/${tgClean}" target="_blank">${tg}</a>` : '‚Äî'}</div>
    </div>`;
  if (app['–†–µ–∑—é–º–µ']) {
    contactsHTML += `
    <div class="modal-contact">
      <div class="label">–†–µ–∑—é–º–µ</div>
      <div class="value"><a href="${app['–†–µ–∑—é–º–µ']}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å ‚Üó</a></div>
    </div>`;
  }
  contacts.innerHTML = contactsHTML;

  // Questions
  const questions = document.getElementById('modalQuestions');
  let qHTML = '';

  if (app['–õ—É—á—à–∞—è —Å–¥–µ–ª–∫–∞']) {
    qHTML += `<div class="modal-question">
      <div class="q-label">–õ—É—á—à–∞—è —Å–¥–µ–ª–∫–∞</div>
      <div class="q-answer">${escapeHtml(app['–õ—É—á—à–∞—è —Å–¥–µ–ª–∫–∞'])}</div>
    </div>`;
  }
  if (app['–ü–ª–∞–Ω –ø–æ —Ç–µ–Ω–¥–µ—Ä–∞–º']) {
    qHTML += `<div class="modal-question">
      <div class="q-label">–ü–ª–∞–Ω –ø–æ —Ç–µ–Ω–¥–µ—Ä–∞–º –∑–∞ 30 –¥–Ω–µ–π</div>
      <div class="q-answer">${escapeHtml(app['–ü–ª–∞–Ω –ø–æ —Ç–µ–Ω–¥–µ—Ä–∞–º'])}</div>
    </div>`;
  }
  if (app['–ú–æ—Ç–∏–≤–∞—Ü–∏—è']) {
    qHTML += `<div class="modal-question">
      <div class="q-label">–ü–æ—á–µ–º—É –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è</div>
      <div class="q-answer">${escapeHtml(app['–ú–æ—Ç–∏–≤–∞—Ü–∏—è'])}</div>
    </div>`;
  }
  questions.innerHTML = qHTML;

  // Meta
  document.getElementById('modalDate').textContent = app['–î–∞—Ç–∞'] || '';

  // Status selector
  currentModalIndex = index;
  const status = app['–°—Ç–∞—Ç—É—Å'] || '–ù–æ–≤—ã–π';
  document.querySelectorAll('#statusSelector .status-option').forEach(opt => {
    opt.classList.toggle('active', opt.dataset.status === status);
  });

  document.getElementById('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
  document.body.style.overflow = '';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

document.getElementById('modalClose').addEventListener('click', closeModal);
document.getElementById('modalOverlay').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeModal();
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});

/* ======================== STATUS CHANGE ======================== */
document.querySelectorAll('#statusSelector .status-option').forEach(opt => {
  opt.addEventListener('click', () => {
    if (currentModalIndex < 0) return;
    const app = allApplications[currentModalIndex];
    if (!app) return;
    const newStatus = opt.dataset.status;
    // Save status
    setAppStatus(app, newStatus);
    // Update selector UI
    document.querySelectorAll('#statusSelector .status-option').forEach(o => {
      o.classList.toggle('active', o.dataset.status === newStatus);
    });
    // Re-render table, cards and stats
    renderAll();
  });
});

/* ======================== FILTERS ======================== */
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.status;
    renderAll();
  });
});

document.getElementById('searchInput').addEventListener('input', renderAll);

/* ======================== SHEETS LINK ======================== */
document.getElementById('sheetsLink').href = SHEET_URL;

/* ======================== REFRESH ======================== */
document.getElementById('refreshBtn').addEventListener('click', loadData);

/* ======================== INIT ======================== */
checkAuth();
</script>

</body>
</html>
